<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Cyber Snake</title>
    <link href="../../static/fonts/inter.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            background: #0f172a;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        canvas {
            border: 2px solid #8b5cf6;
            box-shadow: 0 0 20px #8b5cf6;
            background: rgba(13, 17, 23, 0.8);
        }

        #ui {
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            margin: 0;
            background: linear-gradient(to right, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 3rem;
        }

        #score-board {
            font-size: 1.5rem;
            margin-top: 10px;
        }

        .btn {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1.1rem;
            cursor: pointer;
            border-radius: 8px;
            margin: 10px 5px;
        }

        .btn:hover {
            background: #7c3aed;
        }

        #game-over {
            display: none;
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            padding: 50px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #8b5cf6;
            box-shadow: 0 0 30px #8b5cf6;
        }

        #start-screen {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #8b5cf6;
        }
    </style>
</head>

<body>

    <div id="start-screen">
        <h1>CYBER SNAKE</h1>
        <p>Use arrow keys to move</p>
        <button class="btn" onclick="startGame()">START GAME</button>
    </div>

    <div id="ui" style="display:none;">
        <h1>CYBER SNAKE</h1>
        <div id="score-board">Score: 0</div>
    </div>

    <canvas id="gameCanvas" width="400" height="400"></canvas>

    <div id="game-over">
        <h2>GAME OVER</h2>
        <p>Final Score: <span id="final-score">0</span></p>
        <button class="btn" onclick="startGame()">Play Again</button>
        <button class="btn" onclick="window.location.href='/home'" style="background: #3b82f6;">Home</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score-board');
        const finalScoreEl = document.getElementById('final-score');
        const gameOverScreen = document.getElementById('game-over');
        const startScreen = document.getElementById('start-screen');
        const ui = document.getElementById('ui');

        const gridSize = 20;
        const tileCount = canvas.width / gridSize;

        let snake = [];
        let food = {};
        let velocity = { x: 0, y: 0 };
        let score = 0;
        let gameLoop;
        let isGameRunning = false;

        // Speed control variables
        let baseInterval = 240;  // **TWICE slower** than before (120ms â†’ 240ms)
        let gameStartTime = 0;
        let speedLevel = 0;

        function startGame() {
            score = 0;
            snake = [{ x: 10, y: 10 }];
            velocity = { x: 1, y: 0 };  // Start moving right
            placeFood();
            scoreEl.textContent = `Score: ${score}`;
            gameOverScreen.style.display = 'none';
            startScreen.style.display = 'none';
            ui.style.display = 'block';
            isGameRunning = true;

            gameStartTime = Date.now();
            speedLevel = 0;

            if (gameLoop) clearInterval(gameLoop);
            updateInterval();  // Start with slow speed
            draw();
        }

        function updateInterval() {
            if (!isGameRunning) return;

            // Calculate time elapsed and speed increases
            const elapsedTime = (Date.now() - gameStartTime) / 1000;  // in seconds
            const newSpeedLevel = Math.floor(elapsedTime / 10);  // Every 10 seconds

            if (newSpeedLevel > speedLevel) {
                speedLevel = newSpeedLevel;
                console.log(`Speed increased! Level: ${speedLevel + 1}`);
            }

            // Speed up 10% every level: interval = base / (1.1 ^ level)
            const currentInterval = Math.max(80, baseInterval / Math.pow(1.1, speedLevel));

            if (gameLoop) clearInterval(gameLoop);
            gameLoop = setInterval(update, currentInterval);
        }

        function placeFood() {
            do {
                food = {
                    x: Math.floor(Math.random() * tileCount),
                    y: Math.floor(Math.random() * tileCount)
                };
            } while (snake.some(part => part.x === food.x && part.y === food.y));
        }

        function update() {
            if (!isGameRunning) return;

            const head = { x: snake[0].x + velocity.x, y: snake[0].y + velocity.y };

            // Update speed every frame (smooth acceleration)
            updateInterval();

            // Wall collision
            if (head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount) {
                return endGame();
            }

            // Self collision
            if (snake.some(part => part.x === head.x && part.y === head.y)) {
                return endGame();
            }

            snake.unshift(head);

            // Eat food
            if (head.x === food.x && head.y === food.y) {
                score += 10;
                scoreEl.textContent = `Score: ${score}`;
                placeFood();
            } else {
                snake.pop();
            }

            draw();
        }

        function draw() {
            // Clear
            ctx.fillStyle = '#0f172a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw food
            ctx.fillStyle = '#ef4444';
            ctx.shadowBlur = 15;
            ctx.shadowColor = '#ef4444';
            ctx.fillRect(food.x * gridSize + 2, food.y * gridSize + 2, gridSize - 4, gridSize - 4);
            ctx.shadowBlur = 0;

            // Draw snake
            snake.forEach((part, i) => {
                ctx.fillStyle = i === 0 ? '#60a5fa' : '#3b82f6';
                ctx.fillRect(part.x * gridSize + 2, part.y * gridSize + 2, gridSize - 4, gridSize - 4);

                // Glow effect on head
                if (i === 0) {
                    ctx.shadowBlur = 20;
                    ctx.shadowColor = '#60a5fa';
                    ctx.fillRect(part.x * gridSize + 2, part.y * gridSize + 2, gridSize - 4, gridSize - 4);
                    ctx.shadowBlur = 0;
                }
            });
        }

        function endGame() {
            isGameRunning = false;
            clearInterval(gameLoop);
            finalScoreEl.textContent = score;
            gameOverScreen.style.display = 'block';

            // Optional: submit score
            fetch('/api/score', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ game_id: 'cyber-snake', score })
            }).catch(() => { }); // silent fail if no backend
        }

        // Controls - Prevent reverse direction
        window.addEventListener('keydown', e => {
            if (!isGameRunning) return;

            switch (e.key) {
                case 'ArrowUp':
                    if (velocity.y === 0) velocity = { x: 0, y: -1 };
                    break;
                case 'ArrowDown':
                    if (velocity.y === 0) velocity = { x: 0, y: 1 };
                    break;
                case 'ArrowLeft':
                    if (velocity.x === 0) velocity = { x: -1, y: 0 };
                    break;
                case 'ArrowRight':
                    if (velocity.x === 0) velocity = { x: 1, y: 0 };
                    break;
            }
        });

        // Start with arrow keys too
        window.addEventListener('keydown', e => {
            if (startScreen.style.display !== 'none') {
                if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                    startGame();
                }
            }
        });
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Cyber Sweeper</title>
    <link href="../../static/fonts/inter.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            background: #000000;
            color: #0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden;
        }

        #ui {
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 5px #0f0;
        }

        h1 {
            margin: 0;
            font-size: 2.5rem;
            letter-spacing: 2px;
        }

        #game-stats {
            margin-top: 10px;
            font-size: 1.2rem;
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .game-container {
            position: relative;
            border: 2px solid #0f0;
            padding: 10px;
            background: rgba(0, 20, 0, 0.9);
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
        }

        #grid {
            display: grid;
            grid-template-columns: repeat(10, 30px);
            grid-template-rows: repeat(10, 30px);
            gap: 2px;
        }

        .cell {
            width: 30px;
            height: 30px;
            background: #111;
            border: 1px solid #333;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1rem;
            user-select: none;
        }

        .cell:hover {
            background: #222;
        }

        .cell.revealed {
            background: #000;
            border-color: #0f0;
        }

        .cell.flagged {
            color: #f00;
        }

        .cell.mine {
            background: #f00;
            color: black;
        }

        /* Number Colors */
        .color-1 {
            color: #0f0;
        }

        .color-2 {
            color: #ff0;
        }

        .color-3 {
            color: #f0f;
        }

        .color-4 {
            color: #0ff;
        }

        .color-5 {
            color: #fa0;
        }

        .color-6 {
            color: #0af;
        }

        .color-7 {
            color: #a0f;
        }

        .color-8 {
            color: #fff;
        }

        #modal {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            border: 2px solid #0f0;
            padding: 30px;
            text-align: center;
            z-index: 10;
            box-shadow: 0 0 50px rgba(0, 255, 0, 0.5);
            min-width: 250px;
        }

        .btn {
            background: #0f0;
            color: #000;
            border: none;
            padding: 8px 16px;
            font-size: 1rem;
            font-family: inherit;
            cursor: pointer;
            margin-top: 15px;
            font-weight: bold;
            width: 100%;
            text-transform: uppercase;
        }

        .btn:hover {
            background: #fff;
            box-shadow: 0 0 10px #0f0;
        }

        .scan-line {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(0, 255, 0, 0.3);
            animation: scan 3s linear infinite;
            pointer-events: none;
            z-index: 50;
        }

        @keyframes scan {
            0% {
                top: 0;
            }

            100% {
                top: 100vh;
            }
        }
    </style>
</head>

<body>

    <div class="scan-line"></div>

    <div id="ui">
        <h1>CYBER SWEEPER</h1>
        <div id="game-stats">
            <span>Score: <span id="score">0</span></span>
            <span>Mines: <span id="mines-count">10</span></span>
        </div>
    </div>

    <div class="game-container">
        <div id="grid" oncontextmenu="return false;"></div>
    </div>

    <div id="modal">
        <h2 id="modal-title" style="margin-top: 0;">SYSTEM FAILURE</h2>
        <p>Final Score: <span id="final-score">0</span></p>
        <button class="btn" onclick="initGame()">Reboot System</button>
        <button class="btn" onclick="window.parent.location.href='/home'"
            style="background: transparent; color: #0f0; border: 1px solid #0f0;">Exit to Root</button>
    </div>

    <script>
        const gridEl = document.getElementById('grid');
        const scoreEl = document.getElementById('score');
        const minesCountEl = document.getElementById('mines-count');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const finalScoreEl = document.getElementById('final-score');

        const ROWS = 10;
        const COLS = 10;
        const MINES = 15;

        let grid = [];
        let revealedCount = 0;
        let score = 0;
        let gameOver = false;
        let flags = 0;
        let startTime = 0;

        function initGame() {
            grid = [];
            revealedCount = 0;
            score = 0;
            flags = 0;
            gameOver = false;
            startTime = Date.now();

            scoreEl.innerText = '0';
            minesCountEl.innerText = MINES;
            modal.style.display = 'none';
            gridEl.innerHTML = '';

            // Create grid
            for (let r = 0; r < ROWS; r++) {
                grid[r] = [];
                for (let c = 0; c < COLS; c++) {
                    grid[r][c] = {
                        mine: false,
                        revealed: false,
                        flagged: false,
                        neighbors: 0
                    };
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.dataset.r = r;
                    cell.dataset.c = c;
                    cell.addEventListener('click', () => handleClick(r, c));
                    cell.addEventListener('mousedown', (e) => {
                        if (e.button === 2) handleRightClick(r, c);
                    });
                    gridEl.appendChild(cell);
                    grid[r][c].el = cell; // Reference to DOM element
                }
            }

            // Place mines
            let placed = 0;
            while (placed < MINES) {
                let r = Math.floor(Math.random() * ROWS);
                let c = Math.floor(Math.random() * COLS);
                if (!grid[r][c].mine) {
                    grid[r][c].mine = true;
                    placed++;
                }
            }

            // Calculate numbers
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    if (grid[r][c].mine) continue;
                    let count = 0;
                    for (let i = -1; i <= 1; i++) {
                        for (let j = -1; j <= 1; j++) {
                            if (r + i >= 0 && r + i < ROWS && c + j >= 0 && c + j < COLS) {
                                if (grid[r + i][c + j].mine) count++;
                            }
                        }
                    }
                    grid[r][c].neighbors = count;
                }
            }
        }

        function handleClick(r, c) {
            if (gameOver || grid[r][c].flagged || grid[r][c].revealed) return;

            if (grid[r][c].mine) {
                revealMines();
                endGame(false);
            } else {
                reveal(r, c);
                checkWin();
            }
        }

        function handleRightClick(r, c) {
            if (gameOver || grid[r][c].revealed) return;

            grid[r][c].flagged = !grid[r][c].flagged;
            grid[r][c].el.classList.toggle('flagged');
            grid[r][c].el.innerText = grid[r][c].flagged ? '!' : '';

            flags += grid[r][c].flagged ? 1 : -1;
            minesCountEl.innerText = MINES - flags;
        }

        function reveal(r, c) {
            if (r < 0 || r >= ROWS || c < 0 || c >= COLS || grid[r][c].revealed || grid[r][c].flagged) return;

            grid[r][c].revealed = true;
            grid[r][c].el.classList.add('revealed');
            revealedCount++;

            score += 15; // Points for revealing safe cell
            scoreEl.innerText = score;

            if (grid[r][c].neighbors > 0) {
                grid[r][c].el.innerText = grid[r][c].neighbors;
                grid[r][c].el.classList.add(`color-${grid[r][c].neighbors}`);
            } else {
                // Flood fill
                for (let i = -1; i <= 1; i++) {
                    for (let j = -1; j <= 1; j++) {
                        reveal(r + i, c + j);
                    }
                }
            }
        }

        function revealMines() {
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    if (grid[r][c].mine) {
                        grid[r][c].el.classList.add('mine');
                        grid[r][c].el.innerText = 'X';
                    }
                }
            }
        }

        function checkWin() {
            if (revealedCount === ROWS * COLS - MINES) {
                endGame(true);
            }
        }

        function endGame(win) {
            gameOver = true;
            if (win) {
                let timeTaken = (Date.now() - startTime) / 1000;
                let timeBonus = Math.max(0, Math.floor(1000 - timeTaken * 5));
                score += 1000 + timeBonus;
                modalTitle.innerText = "SYSTEM SECURED";
                modalTitle.style.color = "#0f0";
            } else {
                modalTitle.innerText = "SYSTEM CORRUPTED";
                modalTitle.style.color = "#f00";
            }

            finalScoreEl.innerText = score;
            scoreEl.innerText = score;
            modal.style.display = 'block';

            // Submit score
            fetch('/api/score', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    game_id: 'cyber-sweeper',
                    score: score
                })
            });
        }

        initGame();
    </script>
</body>

</html>
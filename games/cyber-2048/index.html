<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Cyber 2048</title>
    <link href="../../static/fonts/inter.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            background: #0f172a;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        #ui {
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            margin: 0;
            background: linear-gradient(to right, #facc15, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        #score-board {
            font-size: 1.5rem;
            margin-top: 10px;
        }

        .game-container {
            width: 400px;
            height: 400px;
            background: rgba(15, 23, 42, 0.5);
            border: 2px solid #334155;
            border-radius: 10px;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 10px;
            position: relative;
        }

        .tile-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: 10px;
            /* offset for padding */
        }

        .grid-cell {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 5px;
            width: 100%;
            height: 100%;
        }

        .tile {
            position: absolute;
            width: 87.5px;
            /* (400 - 20padding - 30gap) / 4 */
            height: 87.5px;
            background: #334155;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            font-weight: bold;
            transition: all 0.1s ease-in-out;
            color: #0f172a;
        }

        /* Tile Colors */
        .tile-2 {
            background: #e2e8f0;
            box-shadow: 0 0 5px #e2e8f0;
        }

        .tile-4 {
            background: #fef08a;
            box-shadow: 0 0 5px #fef08a;
        }

        .tile-8 {
            background: #facc15;
            box-shadow: 0 0 10px #facc15;
        }

        .tile-16 {
            background: #fb923c;
            box-shadow: 0 0 10px #fb923c;
            color: white;
        }

        .tile-32 {
            background: #f97316;
            box-shadow: 0 0 15px #f97316;
            color: white;
        }

        .tile-64 {
            background: #ef4444;
            box-shadow: 0 0 15px #ef4444;
            color: white;
        }

        .tile-128 {
            background: #ec4899;
            box-shadow: 0 0 20px #ec4899;
            color: white;
            font-size: 1.8rem;
        }

        .tile-256 {
            background: #d946ef;
            box-shadow: 0 0 20px #d946ef;
            color: white;
            font-size: 1.8rem;
        }

        .tile-512 {
            background: #a855f7;
            box-shadow: 0 0 25px #a855f7;
            color: white;
            font-size: 1.8rem;
        }

        .tile-1024 {
            background: #6366f1;
            box-shadow: 0 0 25px #6366f1;
            color: white;
            font-size: 1.5rem;
        }

        .tile-2048 {
            background: #3b82f6;
            box-shadow: 0 0 30px #3b82f6;
            color: white;
            font-size: 1.5rem;
        }

        #game-over {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(15, 23, 42, 0.95);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid #facc15;
            z-index: 20;
        }

        .btn {
            background: #facc15;
            color: #0f172a;
            border: none;
            padding: 10px 20px;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 5px;
            margin-top: 10px;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div id="ui">
        <h1>CYBER 2048</h1>
        <div id="score-board">Score: 0</div>
        <div style="font-size: 0.9rem; color: #94a3b8;">Use Arrow Keys to Merge</div>
    </div>

    <div class="game-container" id="grid-container">
        <!-- Grid Background -->
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>

        <!-- Tiles will be injected here absolutely positioned -->
    </div>

    <div id="game-over">
        <h2>GAME OVER</h2>
        <p>Final Score: <span id="final-score">0</span></p>
        <button class="btn" onclick="initGame()">Try Again</button>
        <button class="btn" onclick="window.parent.location.href='/home'"
            style="background: transparent; color: #94a3b8; border: 1px solid #94a3b8;">Home</button>
    </div>

    <script>
        const gridContainer = document.getElementById('grid-container');
        const scoreEl = document.getElementById('score-board');
        const gameOverScreen = document.getElementById('game-over');
        const finalScoreEl = document.getElementById('final-score');

        let grid = [];
        let score = 0;
        let tileSize = 87.5;
        let gap = 10;

        function initGame() {
            score = 0;
            scoreEl.textContent = `Score: ${score}`;
            gameOverScreen.style.display = 'none';
            grid = Array(4).fill().map(() => Array(4).fill(0));

            // Remove existing tile divs
            const tiles = document.querySelectorAll('.tile');
            tiles.forEach(t => t.remove());

            addNewTile();
            addNewTile();
            drawTiles();
        }

        function addNewTile() {
            let available = [];
            for (let r = 0; r < 4; r++) {
                for (let c = 0; c < 4; c++) {
                    if (grid[r][c] === 0) available.push({ r, c });
                }
            }
            if (available.length === 0) return;

            let spot = available[Math.floor(Math.random() * available.length)];
            grid[spot.r][spot.c] = Math.random() < 0.9 ? 2 : 4;
        }

        function drawTiles() {
            // Clear DOM tiles
            const existing = document.querySelectorAll('.tile');
            existing.forEach(t => t.remove());

            for (let r = 0; r < 4; r++) {
                for (let c = 0; c < 4; c++) {
                    let val = grid[r][c];
                    if (val > 0) {
                        let tile = document.createElement('div');
                        tile.classList.add('tile');
                        tile.classList.add(`tile-${val}`);
                        tile.textContent = val;
                        // Position: padding (10) + (size + gap) * index
                        tile.style.top = `${10 + r * (tileSize + gap)}px`;
                        tile.style.left = `${10 + c * (tileSize + gap)}px`;
                        gridContainer.appendChild(tile);
                    }
                }
            }
        }

        function move(dir) {
            // dir: 0=up, 1=right, 2=down, 3=left
            let method = [slideUp, slideRight, slideDown, slideLeft];
            let changed = method[dir]();

            if (changed) {
                addNewTile();
                drawTiles();
                scoreEl.textContent = `Score: ${score}`;
                if (checkGameOver()) endGame();
            }
        }

        // Standard merge logic helpers
        function slideLeft() {
            let changed = false;
            for (let r = 0; r < 4; r++) {
                let row = grid[r].filter(val => val);
                let merged = [];
                while (row.length > 0) {
                    if (row.length > 1 && row[0] === row[1]) {
                        score += row[0] * 2;
                        merged.push(row[0] * 2);
                        row.shift(); row.shift();
                    } else {
                        merged.push(row[0]);
                        row.shift();
                    }
                }
                while (merged.length < 4) merged.push(0);
                if (grid[r].join(',') !== merged.join(',')) changed = true;
                grid[r] = merged;
            }
            return changed;
        }

        function slideRight() {
            let changed = false;
            for (let r = 0; r < 4; r++) {
                let row = grid[r].filter(val => val);
                let merged = [];
                while (row.length > 0) {
                    if (row.length > 1 && row[row.length - 1] === row[row.length - 2]) {
                        score += row[row.length - 1] * 2;
                        merged.unshift(row[row.length - 1] * 2);
                        row.pop(); row.pop();
                    } else {
                        merged.unshift(row.pop());
                    }
                }
                while (merged.length < 4) merged.unshift(0);
                if (grid[r].join(',') !== merged.join(',')) changed = true;
                grid[r] = merged;
            }
            return changed;
        }

        function slideUp() {
            let changed = false;
            for (let c = 0; c < 4; c++) {
                let col = [grid[0][c], grid[1][c], grid[2][c], grid[3][c]].filter(val => val);
                let merged = [];
                while (col.length > 0) {
                    if (col.length > 1 && col[0] === col[1]) {
                        score += col[0] * 2;
                        merged.push(col[0] * 2);
                        col.shift(); col.shift();
                    } else {
                        merged.push(col[0]);
                        col.shift();
                    }
                }
                while (merged.length < 4) merged.push(0);
                for (let r = 0; r < 4; r++) {
                    if (grid[r][c] !== merged[r]) changed = true;
                    grid[r][c] = merged[r];
                }
            }
            return changed;
        }

        function slideDown() {
            let changed = false;
            for (let c = 0; c < 4; c++) {
                let col = [grid[0][c], grid[1][c], grid[2][c], grid[3][c]].filter(val => val);
                let merged = [];
                while (col.length > 0) {
                    if (col.length > 1 && col[col.length - 1] === col[col.length - 2]) {
                        score += col[col.length - 1] * 2;
                        merged.unshift(col[col.length - 1] * 2);
                        col.pop(); col.pop();
                    } else {
                        merged.unshift(col.pop());
                    }
                }
                while (merged.length < 4) merged.unshift(0);
                for (let r = 0; r < 4; r++) {
                    if (grid[r][c] !== merged[r]) changed = true;
                    grid[r][c] = merged[r];
                }
            }
            return changed;
        }

        function checkGameOver() {
            for (let r = 0; r < 4; r++) {
                for (let c = 0; c < 4; c++) {
                    if (grid[r][c] === 0) return false;
                    if (c < 3 && grid[r][c] === grid[r][c + 1]) return false;
                    if (r < 3 && grid[r][c] === grid[r + 1][c]) return false;
                }
            }
            return true;
        }

        function endGame() {
            finalScoreEl.textContent = score;
            gameOverScreen.style.display = 'block';

            fetch('/api/score', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    game_id: 'cyber-2048',
                    score: score
                })
            });
        }

        document.addEventListener('keydown', e => {
            if (gameOverScreen.style.display === 'block') return;

            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                e.preventDefault();
            }

            switch (e.key) {
                case 'ArrowUp': move(0); break;
                case 'ArrowRight': move(1); break;
                case 'ArrowDown': move(2); break;
                case 'ArrowLeft': move(3); break;
            }
        });

        initGame();
    </script>
</body>

</html>